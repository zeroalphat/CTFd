{% extends "base.html" %}

{% block stylesheets %}
{% endblock %}

{% block content %}
<html>

<script src="../static/js/cbor.js"></script>
<body>
<div class="jumbotron">
	<div class="container">
		<h1>Register</h1>
	</div>
</div>
<div class="container">
	<div class="row">
		<div class="col-md-6 offset-md-3">
			{% for error in errors %}
				<div class="alert alert-danger alert-dismissable" role="alert">
				  <span class="sr-only">Error:</span>
				  {{ error }}
				  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
				</div>
			{% endfor %}
			<form method="post" accept-charset="utf-8" autocomplete="off" role="form" class="form-horizontal">
				<div class="form-group">
					<label for="name-input">
						Team Name
					</label>
					<input class="form-control" type="text" name="name" id="name-input" {% if name %}value="{{ name }}"{% endif %} />
				</div>
				<div class="form-group">
					<label for="email-input">
						Email
					</label>
					<input class="form-control" type="text" name="email" id="email-input" {% if email %}value="{{ email }}"{% endif %} />
				</div>
				<div class="form-group">
					<label for="password-input">
						Password
					</label>
					<input class="form-control" type="password" name="password" id="password-input" {% if password %}value="{{ password }}"{% endif %}/>
				</div>
				<div class="row pt-3">
					<div class="col-md-12">
						<button type="submit" id="submit" tabindex="5" class="btn btn-md btn-primary btn-outlined float-right" onclick="">Submit</button>
					</div>
				</div>
				<input type="hidden" name="nonce" value="{{ nonce }}">
			</form>
		</div>
	</div>
</div>

<script>
	fetch('/register', {
		method: 'GET',
	}).then(function(response) {
		if(response.ok) return response.arrayBuffer();
		throw new Eror('Error getting registaration deta!');
	}).then(CBOR.decode).then(function(options) {
		return navigator.credentials.create(options);
	}).then(function(attestation) {
		return fetch('/register/complete', {
			method: 'POST',
			headers: {'Content-Type': 'application/cbor'},
			body: CBOR.encode({
				"attestationObject": new Uint8Array(attestation.response.attestationObject);
				"clientDataJSON": new Uint8Array(attestation.response.clientDataJSON),
			})
		});
	}).then(function(response){
		var stat = response.ok ? 'successful' : 'unsuccessful';
		alert('Registration' + stat);
	}, function(reason) {
		alert(reason);
	}).then(function() {
		window.location = '/challenges.html';
	});
</script>
</body>
</html>
{% endblock %}

{% block scripts %}
{% endblock %}
